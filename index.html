<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>局域网摄像头麦克风共享工具</title>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        video {
            width: 100%;
            max-height: 70vh;
            background-color: #000;
        }
        .device-card {
            transition: all 0.3s ease;
        }
        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">局域网摄像头麦克风共享工具</h1>
            <p class="text-gray-600">将手机变成电脑的外挂摄像头和麦克风设备</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 控制面板 -->
            <div class="bg-white rounded-xl shadow-lg p-6 device-card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">控制面板</h2>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="room-id">
                        房间ID (用于连接设备)
                    </label>
                    <div class="flex">
                        <input 
                            type="text" 
                            id="room-id" 
                            class="shadow appearance-none border rounded-l w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="输入房间ID或使用默认值"
                            value="room123"
                        >
                        <button 
                            id="copy-room-id" 
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r focus:outline-none focus:shadow-outline"
                        >
                            复制
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button 
                        id="start-camera" 
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center"
                    >
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        启动摄像头
                    </button>
                    
                    <button 
                        id="stop-camera" 
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center"
                        disabled
                    >
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                        </svg>
                        停止摄像头
                    </button>
                </div>

                <div class="mb-6">
                    <label class="inline-flex items-center">
                        <input 
                            type="checkbox" 
                            id="audio-toggle" 
                            class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-offset-0 focus:ring-indigo-200 focus:ring-opacity-50"
                            checked
                        >
                        <span class="ml-2 text-gray-700">启用麦克风</span>
                    </label>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                使用说明：在电脑端打开此页面作为接收端，在手机端打开作为发送端。确保两个设备在同一局域网中。
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">连接状态</h3>
                    <div id="status" class="text-sm p-3 bg-gray-100 rounded">
                        未连接
                    </div>
                </div>
            </div>

            <!-- 视频预览 -->
            <div class="bg-white rounded-xl shadow-lg p-6 device-card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">视频预览</h2>
                <div class="aspect-w-16 aspect-h-9 bg-black rounded-lg overflow-hidden">
                    <video id="remote-video" autoplay playsinline controls></video>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">本地预览</h3>
                    <div class="aspect-w-16 aspect-h-9 bg-black rounded-lg overflow-hidden">
                        <video id="local-video" autoplay playsinline muted></video>
                    </div>
                </div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="mt-12 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">使用说明</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="border-l-4 border-blue-500 pl-4">
                    <h3 class="text-lg font-medium text-gray-800">步骤一</h3>
                    <p class="text-gray-600 mt-2">在电脑上打开此页面，记下房间ID或使用默认值。</p>
                </div>
                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="text-lg font-medium text-gray-800">步骤二</h3>
                    <p class="text-gray-600 mt-2">在手机浏览器中打开同一页面，输入相同的房间ID。</p>
                </div>
                <div class="border-l-4 border-purple-500 pl-4">
                    <h3 class="text-lg font-medium text-gray-800">步骤三</h3>
                    <p class="text-gray-600 mt-2">点击手机端的"启动摄像头"按钮，电脑端即可看到手机画面和声音。</p>
                </div>
            </div>
        </div>

        <!-- 技术信息 -->
        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>基于WebRTC技术，仅在局域网内传输数据，无需外部服务器</p>
        </div>
    </div>

    <script>
        // DOM元素
        const roomIdInput = document.getElementById('room-id');
        const copyRoomIdBtn = document.getElementById('copy-room-id');
        const startCameraBtn = document.getElementById('start-camera');
        const stopCameraBtn = document.getElementById('stop-camera');
        const audioToggle = document.getElementById('audio-toggle');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const statusDiv = document.getElementById('status');

        // WebRTC相关变量
        let localStream = null;
        let peerConnection = null;
        let isInitiator = false;

        // 配置信息
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // 更新状态显示
        function updateStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = isError ? 
                'text-sm p-3 bg-red-100 text-red-700 rounded' : 
                'text-sm p-3 bg-gray-100 rounded';
        }

        // 复制房间ID到剪贴板
        copyRoomIdBtn.addEventListener('click', () => {
            roomIdInput.select();
            document.execCommand('copy');
            const originalText = copyRoomIdBtn.textContent;
            copyRoomIdBtn.textContent = '已复制!';
            setTimeout(() => {
                copyRoomIdBtn.textContent = originalText;
            }, 2000);
        });

        // 启动摄像头
        startCameraBtn.addEventListener('click', async () => {
            try {
                updateStatus('正在获取媒体设备...');
                
                // 获取用户媒体流
                const constraints = {
                    video: {
                        facingMode: 'user', // 优先使用前置摄像头
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: audioToggle.checked
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                localVideo.srcObject = localStream;
                
                updateStatus('媒体设备已就绪，正在建立连接...');
                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                
                // 初始化WebRTC连接
                initializePeerConnection();
                
                // 设置为发起方
                isInitiator = true;
                
                // 创建并发送offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // 在实际应用中，这里应该通过信令服务器发送offer
                // 为了简化演示，我们直接在控制台输出
                console.log('发送offer:', offer);
                updateStatus('连接已建立，正在等待远程设备响应...');
                
            } catch (error) {
                console.error('获取媒体设备失败:', error);
                updateStatus(`错误: ${error.message}`, true);
                startCameraBtn.disabled = false;
                stopCameraBtn.disabled = true;
            }
        });

        // 停止摄像头
        stopCameraBtn.addEventListener('click', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            
            startCameraBtn.disabled = false;
            stopCameraBtn.disabled = true;
            updateStatus('连接已断开');
        });

        // 初始化WebRTC连接
        function initializePeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            
            // 添加本地流到连接
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // 监听远程流
            peerConnection.ontrack = event => {
                console.log('接收到远程流');
                remoteVideo.srcObject = event.streams[0];
                updateStatus('已成功接收远程视频流');
            };
            
            // ICE候选处理
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    // 在实际应用中，这里应该通过信令服务器发送ICE候选
                    console.log('发送ICE候选:', event.candidate);
                }
            };
            
            // 连接状态变化
            peerConnection.onconnectionstatechange = () => {
                console.log('连接状态:', peerConnection.connectionState);
                switch(peerConnection.connectionState) {
                    case "connected":
                        updateStatus('连接成功建立');
                        break;
                    case "disconnected":
                        updateStatus('连接已断开');
                        break;
                    case "failed":
                        updateStatus('连接失败', true);
                        break;
                }
            };
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 检查浏览器支持
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus('您的浏览器不支持WebRTC，请使用最新版Chrome、Firefox或Safari', true);
                startCameraBtn.disabled = true;
            } else {
                updateStatus('准备就绪，请点击"启动摄像头"开始');
            }
            
            // 提示用户需要HTTPS环境（除了localhost）
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                updateStatus('注意：WebRTC需要HTTPS环境才能正常工作', true);
            }
        });

        // 音频开关事件监听
        audioToggle.addEventListener('change', () => {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = audioToggle.checked;
                });
            }
        });
    </script>
</body>
</html>
