<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>局域网摄像头麦克风工具</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        * { box-sizing: border-box; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        video { background: #000; }
        .status-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .connected { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .disconnected { background: #ef4444; }
        .waiting { background: #eab308; animation: pulse 1s infinite; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- 模式选择页面 -->
    <div id="modeSelect" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-2xl w-full">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-2">📱 局域网摄像头/麦克风工具</h1>
            <p class="text-gray-400 text-center mb-8">将手机变成电脑的无线摄像头和麦克风</p>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- 手机端 -->
                <div class="bg-gray-800 rounded-2xl p-6 hover:bg-gray-750 transition cursor-pointer border-2 border-transparent hover:border-blue-500"
                     onclick="startPhoneMode()">
                    <div class="text-6xl text-center mb-4">📱</div>
                    <h2 class="text-xl font-bold text-center mb-2">手机端（发送）</h2>
                    <p class="text-gray-400 text-sm text-center">
                        在手机上打开此页面，共享摄像头和麦克风
                    </p>
                    <div class="mt-4 bg-blue-600 text-center py-3 rounded-lg font-medium">
                        选择此模式
                    </div>
                </div>
                
                <!-- 电脑端 -->
                <div class="bg-gray-800 rounded-2xl p-6 hover:bg-gray-750 transition cursor-pointer border-2 border-transparent hover:border-green-500"
                     onclick="startPCMode()">
                    <div class="text-6xl text-center mb-4">💻</div>
                    <h2 class="text-xl font-bold text-center mb-2">电脑端（接收）</h2>
                    <p class="text-gray-400 text-sm text-center">
                        在电脑上打开此页面，接收手机的音视频流
                    </p>
                    <div class="mt-4 bg-green-600 text-center py-3 rounded-lg font-medium">
                        选择此模式
                    </div>
                </div>
            </div>
            
            <div class="mt-8 bg-gray-800 rounded-xl p-4">
                <h3 class="font-bold mb-2">📋 使用说明：</h3>
                <ol class="text-gray-400 text-sm space-y-1 list-decimal list-inside">
                    <li>确保手机和电脑连接同一个WiFi网络</li>
                    <li>在电脑浏览器打开此页面，选择"电脑端"</li>
                    <li>在手机浏览器输入显示的地址，选择"手机端"</li>
                    <li>输入相同的房间号即可连接</li>
                </ol>
                <div class="mt-3 p-3 bg-yellow-900/30 rounded-lg text-yellow-400 text-sm">
                    ⚠️ 需要使用 HTTPS 或 localhost 才能访问摄像头。建议使用支持的浏览器（Chrome/Edge/Safari）
                </div>
            </div>
        </div>
    </div>

    <!-- 手机端界面 -->
    <div id="phoneUI" class="hidden min-h-screen flex flex-col">
        <div class="bg-gray-800 p-4 flex items-center justify-between">
            <button onclick="backToMode()" class="text-gray-400 hover:text-white">← 返回</button>
            <h2 class="font-bold">📱 手机端 - 发送</h2>
            <div class="flex items-center gap-2">
                <span class="status-dot" id="phoneStatus"></span>
                <span id="phoneStatusText" class="text-sm">未连接</span>
            </div>
        </div>
        
        <div class="flex-1 flex flex-col p-4 gap-4">
            <!-- 连接区域 -->
            <div id="phoneConnect" class="bg-gray-800 rounded-xl p-4">
                <label class="block text-sm text-gray-400 mb-2">房间号（与电脑端相同）</label>
                <div class="flex gap-2">
                    <input type="text" id="phoneRoomId" placeholder="输入房间号" 
                           class="flex-1 bg-gray-700 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="phoneConnect()" id="phoneConnectBtn"
                            class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium">
                        连接
                    </button>
                </div>
            </div>
            
            <!-- 预览区域 -->
            <div class="flex-1 bg-gray-800 rounded-xl overflow-hidden relative">
                <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover"></video>
                <div id="noVideo" class="absolute inset-0 flex items-center justify-center bg-gray-800">
                    <span class="text-gray-500">点击下方按钮开启摄像头</span>
                </div>
            </div>
            
            <!-- 控制按钮 -->
            <div class="grid grid-cols-3 gap-3">
                <button onclick="toggleCamera()" id="cameraBtn" 
                        class="bg-gray-700 hover:bg-gray-600 p-4 rounded-xl flex flex-col items-center gap-2">
                    <span class="text-2xl" id="cameraIcon">📷</span>
                    <span class="text-xs" id="cameraText">开启摄像头</span>
                </button>
                <button onclick="toggleMic()" id="micBtn"
                        class="bg-gray-700 hover:bg-gray-600 p-4 rounded-xl flex flex-col items-center gap-2">
                    <span class="text-2xl" id="micIcon">🎤</span>
                    <span class="text-xs" id="micText">开启麦克风</span>
                </button>
                <button onclick="switchCamera()" id="switchBtn"
                        class="bg-gray-700 hover:bg-gray-600 p-4 rounded-xl flex flex-col items-center gap-2 opacity-50" disabled>
                    <span class="text-2xl">🔄</span>
                    <span class="text-xs">切换摄像头</span>
                </button>
            </div>
            
            <!-- 设置 -->
            <div class="bg-gray-800 rounded-xl p-4">
                <h3 class="font-medium mb-3">视频质量</h3>
                <select id="videoQuality" onchange="updateQuality()" 
                        class="w-full bg-gray-700 rounded-lg px-4 py-2 outline-none">
                    <option value="low">低 (640x480)</option>
                    <option value="medium" selected>中 (1280x720)</option>
                    <option value="high">高 (1920x1080)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- 电脑端界面 -->
    <div id="pcUI" class="hidden min-h-screen flex flex-col">
        <div class="bg-gray-800 p-4 flex items-center justify-between">
            <button onclick="backToMode()" class="text-gray-400 hover:text-white">← 返回</button>
            <h2 class="font-bold">💻 电脑端 - 接收</h2>
            <div class="flex items-center gap-2">
                <span class="status-dot" id="pcStatus"></span>
                <span id="pcStatusText" class="text-sm">未连接</span>
            </div>
        </div>
        
        <div class="flex-1 flex flex-col lg:flex-row p-4 gap-4">
            <!-- 主视频区域 -->
            <div class="flex-1 flex flex-col gap-4">
                <div class="flex-1 bg-black rounded-xl overflow-hidden relative min-h-[300px]">
                    <video id="remoteVideo" autoplay playsinline class="w-full h-full object-contain"></video>
                    <div id="waitingOverlay" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900">
                        <div class="text-6xl mb-4">📱</div>
                        <span class="text-gray-400">等待手机连接...</span>
                    </div>
                    <!-- 全屏按钮 -->
                    <button onclick="toggleFullscreen()" 
                            class="absolute bottom-4 right-4 bg-black/50 hover:bg-black/70 p-2 rounded-lg">
                        ⛶ 全屏
                    </button>
                </div>
                
                <!-- 音频可视化 -->
                <div class="bg-gray-800 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-400">音频电平</span>
                        <span id="audioLevel" class="text-sm">0%</span>
                    </div>
                    <div class="h-4 bg-gray-700 rounded-full overflow-hidden">
                        <div id="audioBar" class="h-full bg-green-500 transition-all duration-100" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- 侧边栏 -->
            <div class="lg:w-80 flex flex-col gap-4">
                <!-- 连接信息 -->
                <div class="bg-gray-800 rounded-xl p-4">
                    <h3 class="font-medium mb-3">🔗 连接设置</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">本机地址</label>
                            <div class="bg-gray-700 rounded-lg px-3 py-2 text-sm break-all" id="localAddress">
                                检测中...
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">房间号</label>
                            <div class="flex gap-2">
                                <input type="text" id="pcRoomId" placeholder="输入房间号" 
                                       class="flex-1 bg-gray-700 rounded-lg px-3 py-2 outline-none text-sm">
                                <button onclick="generateRoom()" class="bg-gray-600 hover:bg-gray-500 px-3 rounded-lg text-sm">
                                    随机
                                </button>
                            </div>
                        </div>
                        <button onclick="pcConnect()" id="pcConnectBtn"
                                class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-medium">
                            开始等待连接
                        </button>
                    </div>
                </div>
                
                <!-- 虚拟设备说明 -->
                <div class="bg-gray-800 rounded-xl p-4">
                    <h3 class="font-medium mb-3">🎥 作为虚拟摄像头</h3>
                    <p class="text-gray-400 text-sm mb-3">
                        要在其他软件中使用此视频流，可以：
                    </p>
                    <ol class="text-gray-400 text-sm space-y-2 list-decimal list-inside">
                        <li>安装 OBS Studio</li>
                        <li>添加"窗口捕获"源，选择此浏览器窗口</li>
                        <li>启用 OBS 虚拟摄像头</li>
                        <li>在其他软件中选择 OBS 虚拟摄像头</li>
                    </ol>
                </div>
                
                <!-- 连接日志 -->
                <div class="bg-gray-800 rounded-xl p-4 flex-1">
                    <h3 class="font-medium mb-3">📋 连接日志</h3>
                    <div id="logArea" class="h-40 overflow-y-auto text-xs text-gray-400 space-y-1 font-mono">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== 全局变量 ====================
        let mode = null; // 'phone' or 'pc'
        let localStream = null;
        let peerConnection = null;
        let dataChannel = null;
        let signalingChannel = null;
        let cameraEnabled = false;
        let micEnabled = false;
        let facingMode = 'environment';
        let audioContext = null;
        let audioAnalyser = null;
        
        // WebRTC 配置 - 使用公共STUN服务器
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };
        
        // 简易信令服务器（使用BroadcastChannel模拟本地，实际使用localStorage轮询）
        const SIGNAL_KEY = 'webrtc_signal_';
        let pollInterval = null;
        let roomId = null;
        
        // ==================== 模式切换 ====================
        function startPhoneMode() {
            mode = 'phone';
            document.getElementById('modeSelect').classList.add('hidden');
            document.getElementById('phoneUI').classList.remove('hidden');
            updatePhoneStatus('disconnected', '未连接');
        }
        
        function startPCMode() {
            mode = 'pc';
            document.getElementById('modeSelect').classList.add('hidden');
            document.getElementById('pcUI').classList.remove('hidden');
            updatePCStatus('disconnected', '未连接');
            detectLocalAddress();
            generateRoom();
        }
        
        function backToMode() {
            cleanup();
            document.getElementById('modeSelect').classList.remove('hidden');
            document.getElementById('phoneUI').classList.add('hidden');
            document.getElementById('pcUI').classList.add('hidden');
            mode = null;
        }
        
        // ==================== 手机端功能 ====================
        async function toggleCamera() {
            if (!cameraEnabled) {
                try {
                    const quality = getQualityConstraints();
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { ...quality, facingMode: facingMode }
                    });
                    
                    if (!localStream) {
                        localStream = new MediaStream();
                    }
                    
                    // 移除旧视频轨道
                    localStream.getVideoTracks().forEach(t => {
                        localStream.removeTrack(t);
                        t.stop();
                    });
                    
                    // 添加新视频轨道
                    stream.getVideoTracks().forEach(t => localStream.addTrack(t));
                    
                    document.getElementById('localVideo').srcObject = localStream;
                    document.getElementById('noVideo').classList.add('hidden');
                    document.getElementById('cameraIcon').textContent = '📷';
                    document.getElementById('cameraText').textContent = '关闭摄像头';
                    document.getElementById('cameraBtn').classList.add('bg-green-600');
                    document.getElementById('cameraBtn').classList.remove('bg-gray-700');
                    document.getElementById('switchBtn').disabled = false;
                    document.getElementById('switchBtn').classList.remove('opacity-50');
                    cameraEnabled = true;
                    
                    // 更新 PeerConnection
                    updatePeerConnectionTracks();
                } catch (err) {
                    alert('无法访问摄像头: ' + err.message);
                    log('摄像头错误: ' + err.message);
                }
            } else {
                localStream?.getVideoTracks().forEach(t => {
                    t.stop();
                    localStream.removeTrack(t);
                });
                document.getElementById('noVideo').classList.remove('hidden');
                document.getElementById('cameraIcon').textContent = '📷';
                document.getElementById('cameraText').textContent = '开启摄像头';
                document.getElementById('cameraBtn').classList.remove('bg-green-600');
                document.getElementById('cameraBtn').classList.add('bg-gray-700');
                document.getElementById('switchBtn').disabled = true;
                document.getElementById('switchBtn').classList.add('opacity-50');
                cameraEnabled = false;
            }
        }
        
        async function toggleMic() {
            if (!micEnabled) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    if (!localStream) {
                        localStream = new MediaStream();
                    }
                    
                    stream.getAudioTracks().forEach(t => localStream.addTrack(t));
                    
                    document.getElementById('micIcon').textContent = '🎤';
                    document.getElementById('micText').textContent = '关闭麦克风';
                    document.getElementById('micBtn').classList.add('bg-green-600');
                    document.getElementById('micBtn').classList.remove('bg-gray-700');
                    micEnabled = true;
                    
                    // 更新 PeerConnection
                    updatePeerConnectionTracks();
                } catch (err) {
                    alert('无法访问麦克风: ' + err.message);
                    log('麦克风错误: ' + err.message);
                }
            } else {
                localStream?.getAudioTracks().forEach(t => {
                    t.stop();
                    localStream.removeTrack(t);
                });
                document.getElementById('micIcon').textContent = '🎤';
                document.getElementById('micText').textContent = '开启麦克风';
                document.getElementById('micBtn').classList.remove('bg-green-600');
                document.getElementById('micBtn').classList.add('bg-gray-700');
                micEnabled = false;
            }
        }
        
        async function switchCamera() {
            if (!cameraEnabled) return;
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            
            // 重新获取摄像头
            localStream?.getVideoTracks().forEach(t => t.stop());
            cameraEnabled = false;
            await toggleCamera();
        }
        
        function getQualityConstraints() {
            const quality = document.getElementById('videoQuality')?.value || 'medium';
            switch (quality) {
                case 'low': return { width: 640, height: 480 };
                case 'high': return { width: 1920, height: 1080 };
                default: return { width: 1280, height: 720 };
            }
        }
        
        async function updateQuality() {
            if (cameraEnabled) {
                cameraEnabled = false;
                await toggleCamera();
            }
        }
        
        function updatePeerConnectionTracks() {
            if (!peerConnection || !localStream) return;
            
            const senders = peerConnection.getSenders();
            
            localStream.getTracks().forEach(track => {
                const sender = senders.find(s => s.track?.kind === track.kind);
                if (sender) {
                    sender.replaceTrack(track);
                } else {
                    peerConnection.addTrack(track, localStream);
                }
            });
        }
        
        // ==================== 电脑端功能 ====================
        function detectLocalAddress() {
            const addr = window.location.href;
            document.getElementById('localAddress').textContent = addr;
        }
        
        function generateRoom() {
            const id = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('pcRoomId').value = id;
        }
        
        function toggleFullscreen() {
            const video = document.getElementById('remoteVideo');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                video.requestFullscreen?.() || video.webkitRequestFullscreen?.();
            }
        }
        
        function setupAudioVisualization(stream) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioAnalyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(audioAnalyser);
                audioAnalyser.fftSize = 256;
                
                const dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
                
                function updateLevel() {
                    if (!audioAnalyser) return;
                    audioAnalyser.getByteFrequencyData(dataArray);
                    const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                    const level = Math.min(100, avg * 1.5);
                    document.getElementById('audioBar').style.width = level + '%';
                    document.getElementById('audioLevel').textContent = Math.round(level) + '%';
                    requestAnimationFrame(updateLevel);
                }
                updateLevel();
            } catch (err) {
                log('音频可视化错误: ' + err.message);
            }
        }
        
        // ==================== WebRTC 信令 ====================
        function phoneConnect() {
            roomId = document.getElementById('phoneRoomId').value.trim().toUpperCase();
            if (!roomId) {
                alert('请输入房间号');
                return;
            }
            
            document.getElementById('phoneConnectBtn').textContent = '连接中...';
            document.getElementById('phoneConnectBtn').disabled = true;
            
            updatePhoneStatus('waiting', '等待连接...');
            log('手机端加入房间: ' + roomId);
            
            // 开始轮询信令
            startSignaling('phone');
        }
        
        function pcConnect() {
            roomId = document.getElementById('pcRoomId').value.trim().toUpperCase();
            if (!roomId) {
                alert('请输入房间号');
                return;
            }
            
            document.getElementById('pcConnectBtn').textContent = '等待中...';
            document.getElementById('pcConnectBtn').disabled = true;
            
            updatePCStatus('waiting', '等待手机连接...');
            log('电脑端创建房间: ' + roomId);
            
            // 开始轮询信令
            startSignaling('pc');
        }
        
        function startSignaling(role) {
            // 清除旧信号
            localStorage.removeItem(SIGNAL_KEY + roomId + '_offer');
            localStorage.removeItem(SIGNAL_KEY + roomId + '_answer');
            localStorage.removeItem(SIGNAL_KEY + roomId + '_ice_phone');
            localStorage.removeItem(SIGNAL_KEY + roomId + '_ice_pc');
            
            if (role === 'pc') {
                // 电脑端等待 offer
                pollInterval = setInterval(() => {
                    const offer = localStorage.getItem(SIGNAL_KEY + roomId + '_offer');
                    if (offer && !peerConnection) {
                        log('收到手机端 Offer');
                        handleOffer(JSON.parse(offer));
                    }
                    
                    // 检查 ICE candidates
                    const iceCandidates = localStorage.getItem(SIGNAL_KEY + roomId + '_ice_phone');
                    if (iceCandidates && peerConnection) {
                        const candidates = JSON.parse(iceCandidates);
                        candidates.forEach(c => {
                            if (c && !c.added) {
                                peerConnection.addIceCandidate(new RTCIceCandidate(c.candidate));
                                c.added = true;
                            }
                        });
                        localStorage.setItem(SIGNAL_KEY + roomId + '_ice_phone', JSON.stringify(candidates));
                    }
                }, 500);
            } else {
                // 手机端创建 offer
                createOffer();
                
                pollInterval = setInterval(() => {
                    const answer = localStorage.getItem(SIGNAL_KEY + roomId + '_answer');
                    if (answer && peerConnection && peerConnection.signalingState === 'have-local-offer') {
                        log('收到电脑端 Answer');
                        handleAnswer(JSON.parse(answer));
                    }
                    
                    // 检查 ICE candidates
                    const iceCandidates = localStorage.getItem(SIGNAL_KEY + roomId + '_ice_pc');
                    if (iceCandidates && peerConnection) {
                        const candidates = JSON.parse(iceCandidates);
                        candidates.forEach(c => {
                            if (c && !c.added) {
                                peerConnection.addIceCandidate(new RTCIceCandidate(c.candidate));
                                c.added = true;
                            }
                        });
                        localStorage.setItem(SIGNAL_KEY + roomId + '_ice_pc', JSON.stringify(candidates));
                    }
                }, 500);
            }
        }
        
        async function createOffer() {
            peerConnection = new RTCPeerConnection(rtcConfig);
            setupPeerConnectionHandlers();
            
            // 添加本地流
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            } else {
                // 如果还没有流，添加一个空的音视频轨道
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    localStream = stream;
                    document.getElementById('localVideo').srcObject = stream;
                    document.getElementById('noVideo').classList.add('hidden');
                    cameraEnabled = true;
                    micEnabled = true;
                    
                    document.getElementById('cameraIcon').textContent = '📷';
                    document.getElementById('cameraText').textContent = '关闭摄像头';
                    document.getElementById('cameraBtn').classList.add('bg-green-600');
                    document.getElementById('micIcon').textContent = '🎤';
                    document.getElementById('micText').textContent = '关闭麦克风';
                    document.getElementById('micBtn').classList.add('bg-green-600');
                    document.getElementById('switchBtn').disabled = false;
                    document.getElementById('switchBtn').classList.remove('opacity-50');
                    
                    stream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, stream);
                    });
                } catch (err) {
                    log('获取媒体失败: ' + err.message);
                    return;
                }
            }
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            localStorage.setItem(SIGNAL_KEY + roomId + '_offer', JSON.stringify(offer));
            log('已发送 Offer');
        }
        
        async function handleOffer(offer) {
            peerConnection = new RTCPeerConnection(rtcConfig);
            setupPeerConnectionHandlers();
            
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            localStorage.setItem(SIGNAL_KEY + roomId + '_answer', JSON.stringify(answer));
            log('已发送 Answer');
        }
        
        async function handleAnswer(answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            log('连接建立中...');
        }
        
        function setupPeerConnectionHandlers() {
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const key = SIGNAL_KEY + roomId + '_ice_' + mode;
                    const existing = JSON.parse(localStorage.getItem(key) || '[]');
                    existing.push({ candidate: event.candidate });
                    localStorage.setItem(key, JSON.stringify(existing));
                }
            };
            
            peerConnection.onconnectionstatechange = () => {
                log('连接状态: ' + peerConnection.connectionState);
                
                if (peerConnection.connectionState === 'connected') {
                    if (mode === 'phone') {
                        updatePhoneStatus('connected', '已连接');
                        document.getElementById('phoneConnectBtn').textContent = '已连接';
                    } else {
                        updatePCStatus('connected', '已连接');
                        document.getElementById('pcConnectBtn').textContent = '已连接';
                        document.getElementById('waitingOverlay').classList.add('hidden');
                    }
                } else if (peerConnection.connectionState === 'disconnected' || 
                           peerConnection.connectionState === 'failed') {
                    if (mode === 'phone') {
                        updatePhoneStatus('disconnected', '连接断开');
                        document.getElementById('phoneConnectBtn').textContent = '重新连接';
                        document.getElementById('phoneConnectBtn').disabled = false;
                    } else {
                        updatePCStatus('disconnected', '连接断开');
                        document.getElementById('pcConnectBtn').textContent = '重新连接';
                        document.getElementById('pcConnectBtn').disabled = false;
                        document.getElementById('waitingOverlay').classList.remove('hidden');
                    }
                    cleanup();
                }
            };
            
            peerConnection.ontrack = (event) => {
                log('收到远程媒体流');
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    document.getElementById('waitingOverlay').classList.add('hidden');
                    
                    // 设置音频可视化
                    if (event.streams[0].getAudioTracks().length > 0) {
                        setupAudioVisualization(event.streams[0]);
                    }
                }
            };
        }
        
        // ==================== 状态更新 ====================
        function updatePhoneStatus(status, text) {
            const dot = document.getElementById('phoneStatus');
            const txt = document.getElementById('phoneStatusText');
            dot.className = 'status-dot ' + status;
            txt.textContent = text;
        }
        
        function updatePCStatus(status, text) {
            const dot = document.getElementById('pcStatus');
            const txt = document.getElementById('pcStatusText');
            dot.className = 'status-dot ' + status;
            txt.textContent = text;
        }
        
        function log(msg) {
            const area = document.getElementById('logArea');
            if (!area) return;
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.textContent = `[${time}] ${msg}`;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
            console.log(msg);
        }
        
        // ==================== 清理 ====================
        function cleanup() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
                audioAnalyser = null;
            }
            
            cameraEnabled = false;
            micEnabled = false;
            
            // 重置UI
            const localVideo = document.getElementById('localVideo');
            if (localVideo) localVideo.srcObject = null;
            
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo) remoteVideo.srcObject = null;
        }
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', cleanup);
        
        // 初始化日志
        log('系统就绪，请选择模式');
    </script>
</body>
</html>
