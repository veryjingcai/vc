<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Win11 WiFi æ‰©å±•è¯ç­’</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        /* Win11 Acrylic/Mica effect simulation */
        body {
            background: radial-gradient(circle at 50% 0%, #2c3e50, #000000);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .btn-primary {
            background: linear-gradient(135deg, #0078d4, #005a9e);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        textarea {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1rem; /* Significantly increased for mobile readability */
            line-height: 1.4;
            font-weight: 600;
            color: #a5f3fc; /* Cyan-200 for better contrast */
        }
        
        /* Audio Visualizer Animation */
        .bar-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 60px;
            gap: 4px;
        }
        .bar {
            width: 6px;
            background: #00d4ff;
            border-radius: 4px;
            height: 5px;
            transition: height 0.1s ease;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 selection:bg-blue-500 selection:text-white">

    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 p-4 flex justify-center gap-4 z-50 bg-black/20 backdrop-blur-md border-b border-white/5">
        <a href="index.html" class="text-blue-400 font-bold border-b-2 border-blue-400 pb-1 text-sm">ğŸ™ï¸ æ‰©å±•è¯ç­’</a>
        <a href="camera.html" class="text-gray-400 hover:text-white transition text-sm font-medium">ğŸ“· æ‰©å±•æ‘„åƒå¤´</a>
    </nav>

    <!-- Main Container -->
    <main class="glass-panel w-full max-w-2xl rounded-2xl p-6 md:p-10 relative overflow-hidden mt-16">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="inline-block p-3 rounded-full bg-blue-500/20 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold mb-2">WiFi æ‰©å±•è¯ç­’</h1>
            <p class="text-gray-400 text-sm">å°†æ‰‹æœºå˜æˆ Windows 11 çš„æ— çº¿éº¦å…‹é£</p>
        </header>

        <!-- Step 1: Role Selection -->
        <div id="step-selection" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="app.initSender()" class="glass-panel hover:bg-white/10 p-6 rounded-xl text-left transition group cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold group-hover:text-blue-300">æˆ‘æ˜¯æ‰‹æœº</h3>
                    <span class="bg-blue-500/20 text-blue-300 text-xs px-2 py-1 rounded">å‘é€ç«¯</span>
                </div>
                <p class="text-gray-400 text-sm">æ•æ‰éº¦å…‹é£å£°éŸ³å¹¶å‘é€ç»™ç”µè„‘ã€‚</p>
            </button>

            <button onclick="app.initReceiver()" class="glass-panel hover:bg-white/10 p-6 rounded-xl text-left transition group cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold group-hover:text-green-300">æˆ‘æ˜¯ç”µè„‘</h3>
                    <span class="bg-green-500/20 text-green-300 text-xs px-2 py-1 rounded">æ¥æ”¶ç«¯</span>
                </div>
                <p class="text-gray-400 text-sm">æ¥æ”¶å£°éŸ³å¹¶æ’­æ”¾ (éœ€é…åˆè™šæ‹Ÿå£°å¡ä½¿ç”¨)ã€‚</p>
            </button>
        </div>

        <!-- Sender Interface (Phone) -->
        <div id="sender-ui" class="hidden space-y-6">
            <div class="text-center">
                <div class="text-emerald-400 font-medium mb-2 flex items-center justify-center gap-2">
                    <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                    æ­£åœ¨æ•æ‰éŸ³é¢‘
                </div>
                <div class="bar-container" id="sender-visualizer">
                    <!-- Bars generated by JS -->
                </div>
            </div>

            <div class="space-y-4 border-t border-white/10 pt-6">
                <h3 class="text-lg font-medium">è¿æ¥æ­¥éª¤ (æ— éœ€æœåŠ¡å™¨)</h3>
                
                <div id="sender-step-1">
                    <p class="text-sm text-gray-400 mb-2">1. å¤åˆ¶ä¸‹æ–¹çš„ <span class="text-blue-300">è¿æ¥ä»£ç  A</span> å‘é€ç»™ç”µè„‘ï¼š</p>
                    <div class="relative">
                        <textarea id="sender-offer" readonly class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-blue-500 text-sm resize-none" placeholder="æ­£åœ¨ç”Ÿæˆä»£ç ...è¯·ç¨å€™" onclick="this.select()"></textarea>
                        <button onclick="app.copyToClipboard('sender-offer')" class="absolute top-2 right-2 bg-white/20 hover:bg-white/30 text-xs px-3 py-1.5 rounded font-bold backdrop-blur-sm">å¤åˆ¶</button>
                    </div>
                </div>

                <div id="sender-step-2" class="opacity-50 pointer-events-none transition-opacity">
                    <p class="text-sm text-gray-400 mb-2">3. å°†ç”µè„‘ç”Ÿæˆçš„ <span class="text-green-300">è¿æ¥ä»£ç  B</span> ç²˜è´´åˆ°è¿™é‡Œï¼š</p>
                    <textarea id="sender-answer-input" class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-blue-500 text-sm resize-none" placeholder="åœ¨æ­¤ç²˜è´´ç”µè„‘çš„ä»£ç ..."></textarea>
                    <button onclick="app.finalizeSenderConnection()" class="mt-3 btn-primary w-full py-3 rounded-lg font-medium shadow-lg shadow-blue-500/30">è¿æ¥ç”µè„‘</button>
                </div>
            </div>
        </div>

        <!-- Receiver Interface (PC) -->
        <div id="receiver-ui" class="hidden space-y-6">
            <div class="bg-yellow-500/10 border border-yellow-500/20 p-4 rounded-lg mb-4">
                <h4 class="text-yellow-400 text-sm font-bold mb-1">âš ï¸ å…³é”®è®¾ç½®æç¤º</h4>
                <p class="text-gray-300 text-xs">
                    æœ¬ç½‘é¡µä¼šæ’­æ”¾æ‰‹æœºçš„å£°éŸ³ã€‚è¦è®©å®ƒæˆä¸ºç³»ç»Ÿéº¦å…‹é£(ç”¨äºQQ/ä¼šè®®ç­‰)ï¼Œè¯·å®‰è£… <strong>VB-Audio Cable</strong>ï¼Œå¹¶åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å°†æµè§ˆå™¨è¾“å‡ºè®¾ä¸º "CABLE Input"ï¼Œå°†ä¼šè®®è½¯ä»¶è¾“å…¥è®¾ä¸º "CABLE Output"ã€‚
                </p>
            </div>

            <div class="space-y-4">
                <div id="receiver-step-1">
                    <p class="text-sm text-gray-400 mb-2">2. å°†æ‰‹æœºçš„ <span class="text-blue-300">è¿æ¥ä»£ç  A</span> ç²˜è´´åˆ°è¿™é‡Œï¼š</p>
                    <textarea id="receiver-offer-input" class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-blue-500 text-sm resize-none" placeholder="åœ¨æ­¤ç²˜è´´æ‰‹æœºçš„ä»£ç ..."></textarea>
                    <button onclick="app.createReceiverAnswer()" class="mt-2 btn-primary w-full py-2 rounded-lg font-medium text-sm shadow-lg shadow-blue-500/20">ç”Ÿæˆä»£ç  B</button>
                </div>

                <div id="receiver-step-2" class="hidden">
                    <p class="text-sm text-gray-400 mb-2">3. å¤åˆ¶ä¸‹æ–¹çš„ <span class="text-green-300">è¿æ¥ä»£ç  B</span> å‘å›ç»™æ‰‹æœºï¼š</p>
                    <div class="relative">
                        <textarea id="receiver-answer" readonly class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-blue-500 text-sm resize-none" onclick="this.select()"></textarea>
                        <button onclick="app.copyToClipboard('receiver-answer')" class="absolute top-2 right-2 bg-white/20 hover:bg-white/30 text-xs px-3 py-1.5 rounded font-bold backdrop-blur-sm">å¤åˆ¶</button>
                    </div>
                    <div class="mt-4 text-center text-emerald-400 animate-pulse text-sm">
                        ç­‰å¾…æ‰‹æœºç¡®è®¤è¿æ¥...
                    </div>
                </div>
                
                <div id="receiver-connected" class="hidden text-center pt-6">
                    <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-white">å·²è¿æ¥</h3>
                    <p class="text-sm text-gray-400 mt-1">æ­£åœ¨æ¥æ”¶æ‰‹æœºéŸ³é¢‘...</p>
                    <div class="bar-container mt-4" id="receiver-visualizer">
                        <!-- Bars -->
                    </div>
                    <button onclick="app.resumeAudio()" class="mt-4 text-xs text-blue-400 hover:underline">æ²¡å£°éŸ³ï¼Ÿç‚¹å‡»è¿™é‡Œæ¿€æ´»éŸ³é¢‘</button>
                </div>
            </div>
        </div>

        <!-- Troubleshooting / Help Section -->
        <div id="https-warning" class="hidden mt-6 p-4 bg-red-500/20 border border-red-500/30 rounded-lg text-left">
            <h4 class="font-bold text-red-300 flex items-center gap-2 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                éº¦å…‹é£æ— æ³•å¯åŠ¨ï¼Ÿ
            </h4>
            <p class="text-sm text-gray-300 mb-2">
                æµè§ˆå™¨å‡ºç° <code>Cannot read properties of undefined (reading 'getUserMedia')</code> é”™è¯¯ï¼Œæ˜¯å› ä¸º<strong>æµè§ˆå™¨å®‰å…¨ç­–ç•¥</strong>ã€‚
            </p>
            <p class="text-xs text-gray-400 mb-3">
                ç°ä»£æµè§ˆå™¨ï¼ˆChrome, Safari, Edgeï¼‰<strong>å¼ºåˆ¶è¦æ±‚ HTTPS</strong> æ‰èƒ½è°ƒç”¨éº¦å…‹é£ã€‚å¦‚æœä½ æ˜¯é€šè¿‡å±€åŸŸç½‘ IP (å¦‚ http://192.168.1.5) è®¿é—®ï¼Œéº¦å…‹é£ä¼šè¢«ç¦ç”¨ã€‚
            </p>
            <div class="text-xs text-gray-300 space-y-2">
                <p><strong>è§£å†³æ–¹æ¡ˆ 1 (æ¨è - éƒ¨ç½²ä¸Šçº¿):</strong><br>å°†æ­¤ HTML æ–‡ä»¶ä¸Šä¼ åˆ° <strong>GitHub Pages, Vercel, æˆ– Netlify</strong> ç­‰å…è´¹ HTTPS æ‰˜ç®¡å¹³å°ï¼Œç„¶åç”¨æ‰‹æœºè®¿é—®ç”Ÿæˆçš„ https ç½‘å€ã€‚</p>
                <p><strong>è§£å†³æ–¹æ¡ˆ 2 (å®‰å“ Chrome è°ƒè¯•):</strong><br>åœ¨æ‰‹æœº Chrome åœ°å€æ è¾“å…¥ <code>chrome://flags/#unsafely-treat-insecure-origin-as-secure</code>ï¼Œå¼€å¯è¯¥é€‰é¡¹ï¼Œå¹¶åœ¨ä¸‹æ–¹çš„æ–‡æœ¬æ¡†å¡«å…¥ç”µè„‘çš„ IP åœ°å€ (å¦‚ http://192.168.1.x:ç«¯å£)ï¼Œç„¶åé‡å¯æµè§ˆå™¨ã€‚</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 pt-4 border-t border-white/5 text-center">
             <button onclick="location.reload()" class="text-xs text-gray-500 hover:text-gray-300 transition">é‡ç½® / æ–­å¼€è¿æ¥</button>
        </div>

    </main>

    <script>
        /**
         * Win11 WiFi Microphone Logic
         * Uses WebRTC for peer-to-peer audio streaming.
         * Uses Manual Signaling (Copy/Paste SDP) to avoid backend server requirement.
         */
        class MicApp {
            constructor() {
                this.peerConnection = null;
                this.localStream = null;
                this.audioContext = null;
                this.analyser = null;
                this.dataChannel = null;
                
                // WebRTC Configuration (STUN servers for WAN, though local network often works without)
                this.rtcConfig = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };

                this.visualizerBars = 10;
            }

            // --- UI Helpers ---
            show(id) { document.getElementById(id).classList.remove('hidden'); }
            hide(id) { document.getElementById(id).classList.add('hidden'); }
            
            // Prevent screen from sleeping (Wake Lock API)
            async requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Screen Wake Lock active');
                        
                        // Re-acquire lock if page becomes visible again (e.g. user switched tabs)
                        document.addEventListener('visibilitychange', async () => {
                            if (this.wakeLock !== null && document.visibilityState === 'visible') {
                                try {
                                    this.wakeLock = await navigator.wakeLock.request('screen');
                                    console.log('Screen Wake Lock re-acquired');
                                } catch(e) { console.log('Re-acquire lock failed', e); }
                            }
                        });
                    }
                } catch (err) {
                    console.log('Wake Lock error:', err);
                }
            }

            async copyToClipboard(elementId) {
                const el = document.getElementById(elementId);
                el.select();
                try {
                    await navigator.clipboard.writeText(el.value);
                    const btn = el.parentElement.querySelector('button');
                    const originalText = btn.innerText;
                    btn.innerText = "å·²å¤åˆ¶!";
                    setTimeout(() => btn.innerText = originalText, 2000);
                } catch (err) {
                    alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
                }
            }

            initVisualizer(containerId, sourceStream) {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Connect stream to analyser
                const source = this.audioContext.createMediaStreamSource(sourceStream);
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 64;
                source.connect(this.analyser);

                // Generate DOM bars
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                for(let i=0; i<this.visualizerBars; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    container.appendChild(bar);
                }

                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const bars = container.querySelectorAll('.bar');

                const draw = () => {
                    requestAnimationFrame(draw);
                    this.analyser.getByteFrequencyData(dataArray);
                    
                    // Simple visualization logic
                    for(let i=0; i<this.visualizerBars; i++) {
                        // Map bars to frequency roughly
                        const index = Math.floor(i * (bufferLength / this.visualizerBars));
                        const value = dataArray[index];
                        const percent = Math.max(10, (value / 255) * 100);
                        bars[i].style.height = percent + '%';
                        
                        // Color reaction
                        if (value > 200) bars[i].style.backgroundColor = '#ff4d4d';
                        else bars[i].style.backgroundColor = '#00d4ff';
                    }
                };
                draw();
            }

            // --- Sender Logic (Phone) ---
            async initSender() {
                this.hide('step-selection');
                this.show('sender-ui');

                try {
                    // 1. Get Microphone
                    // Security Check: getUserMedia is only available in Secure Contexts (HTTPS or localhost)
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        // Show the help guide explicitly
                        this.show('https-warning');
                        throw new Error("æµè§ˆå™¨ç¦æ­¢é HTTPS ç½‘é¡µè®¿é—®éº¦å…‹é£ã€‚è¯·æŸ¥çœ‹ä¸‹æ–¹çš„çº¢è‰²å¸®åŠ©åŒºåŸŸã€‚");
                    }

                    this.localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { 
                            echoCancellation: false, 
                            noiseSuppression: true, 
                            autoGainControl: true 
                        }, 
                        video: false 
                    });

                    // 2. Start Visualizer & Wake Lock
                    this.initVisualizer('sender-visualizer', this.localStream);
                    this.requestWakeLock();

                    // 3. Create Peer Connection
                    this.peerConnection = new RTCPeerConnection(this.rtcConfig);
                    
                    // Add tracks
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });

                    // Create Data Channel (required to establish connection even if audio fails initially)
                    this.dataChannel = this.peerConnection.createDataChannel("chat");

                    // 4. Create Offer
                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);

                    // 5. Wait for ICE Gathering to complete (so we get one single blob to copy)
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate === null) {
                            // Gathering finished
                            const code = btoa(JSON.stringify(this.peerConnection.localDescription));
                            document.getElementById('sender-offer').value = code;
                            
                            // Enable Step 2
                            document.getElementById('sender-step-2').classList.remove('opacity-50', 'pointer-events-none');
                        }
                    };

                } catch (err) {
                    alert("æ— æ³•è®¿é—®éº¦å…‹é£: " + err.message);
                    location.reload();
                }
            }

            async finalizeSenderConnection() {
                const answerStr = document.getElementById('sender-answer-input').value.trim();
                if (!answerStr) return alert("è¯·ç²˜è´´ç”µè„‘çš„ä»£ç  B");

                try {
                    const answerDesc = JSON.parse(atob(answerStr));
                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(answerDesc));
                    alert("è¿æ¥æˆåŠŸï¼æ‚¨çš„æ‰‹æœºç°åœ¨æ˜¯éº¦å…‹é£äº†ã€‚");
                } catch (e) {
                    alert("è¿æ¥ä»£ç æ— æ•ˆï¼Œè¯·æ£€æŸ¥ã€‚");
                }
            }

            // --- Receiver Logic (PC) ---
            initReceiver() {
                this.hide('step-selection');
                this.show('receiver-ui');
                
                this.peerConnection = new RTCPeerConnection(this.rtcConfig);

                // Handle incoming stream
                this.peerConnection.ontrack = (event) => {
                    const remoteStream = event.streams[0];
                    const audio = new Audio();
                    audio.srcObject = remoteStream;
                    audio.play();
                    
                    this.hide('receiver-step-1');
                    this.hide('receiver-step-2');
                    this.show('receiver-connected');

                    this.initVisualizer('receiver-visualizer', remoteStream);
                };
            }

            async createReceiverAnswer() {
                const offerStr = document.getElementById('receiver-offer-input').value.trim();
                if (!offerStr) return alert("è¯·ç²˜è´´æ‰‹æœºçš„ä»£ç  A");

                try {
                    const offerDesc = JSON.parse(atob(offerStr));
                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offerDesc));

                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);

                    // Wait for ICE
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate === null) {
                            const code = btoa(JSON.stringify(this.peerConnection.localDescription));
                            document.getElementById('receiver-answer').value = code;
                            
                            this.hide('receiver-step-1');
                            this.show('receiver-step-2');
                        }
                    };

                } catch (e) {
                    alert("ä»£ç æ— æ•ˆ: " + e.message);
                }
            }
            
            // Helper for autoplay policy blocks
            resumeAudio() {
                if(this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }
        }

        // Initialize
        const app = new MicApp();
    </script>
</body>
</html>
