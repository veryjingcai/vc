<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Win11 WiFi æ‰©å±•æ‘„åƒå¤´</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        /* Win11 Acrylic/Mica effect simulation */
        body {
            background: radial-gradient(circle at 50% 0%, #2c3e50, #000000);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .btn-primary {
            background: linear-gradient(135deg, #0078d4, #005a9e);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        textarea {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1rem;
            line-height: 1.4;
            font-weight: 600;
            color: #a5f3fc;
        }
        video {
            background: #000;
            border-radius: 8px;
            max-height: 60vh;
            width: 100%;
            object-fit: contain;
            transform: rotateY(0deg); /* Reset mirror if needed */
        }
        /* Mirror local video on phone so it feels natural for front cam, but back cam shouldn't be mirrored usually. We'll handle in JS */
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 selection:bg-blue-500 selection:text-white">

    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 p-4 flex justify-center gap-4 z-50 bg-black/20 backdrop-blur-md border-b border-white/5">
        <a href="index.html" class="text-gray-400 hover:text-white transition text-sm font-medium">ğŸ™ï¸ æ‰©å±•è¯ç­’</a>
        <a href="camera.html" class="text-blue-400 font-bold border-b-2 border-blue-400 pb-1 text-sm">ğŸ“· æ‰©å±•æ‘„åƒå¤´</a>
    </nav>

    <!-- Main Container -->
    <main class="glass-panel w-full max-w-3xl rounded-2xl p-6 md:p-10 relative overflow-hidden mt-16">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="inline-block p-3 rounded-full bg-purple-500/20 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold mb-2">WiFi æ‰©å±•æ‘„åƒå¤´</h1>
            <p class="text-gray-400 text-sm">å°†æ‰‹æœºæ‘„åƒå¤´ç”»é¢å®æ—¶ä¼ è¾“åˆ°ç”µè„‘</p>
        </header>

        <!-- Step 1: Role Selection -->
        <div id="step-selection" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="app.initSender()" class="glass-panel hover:bg-white/10 p-6 rounded-xl text-left transition group cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold group-hover:text-purple-300">æˆ‘æ˜¯æ‰‹æœº</h3>
                    <span class="bg-purple-500/20 text-purple-300 text-xs px-2 py-1 rounded">å‘é€ç«¯</span>
                </div>
                <p class="text-gray-400 text-sm">è°ƒç”¨åç½®/å‰ç½®æ‘„åƒå¤´å‘é€è§†é¢‘ã€‚</p>
            </button>

            <button onclick="app.initReceiver()" class="glass-panel hover:bg-white/10 p-6 rounded-xl text-left transition group cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold group-hover:text-green-300">æˆ‘æ˜¯ç”µè„‘</h3>
                    <span class="bg-green-500/20 text-green-300 text-xs px-2 py-1 rounded">æ¥æ”¶ç«¯</span>
                </div>
                <p class="text-gray-400 text-sm">æ¥æ”¶è§†é¢‘ç”»é¢ (å¯é…åˆ OBS ä½¿ç”¨)ã€‚</p>
            </button>
        </div>

        <!-- Sender Interface (Phone) -->
        <div id="sender-ui" class="hidden space-y-6">
            <div class="text-center relative">
                <video id="local-video" autoplay playsinline muted></video>
                <div class="absolute bottom-4 right-4">
                    <button onclick="app.switchCamera()" class="bg-black/50 backdrop-blur p-2 rounded-full text-white hover:bg-white/20" title="åˆ‡æ¢æ‘„åƒå¤´">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                    <button onclick="app.toggleMic()" id="btn-toggle-mic" class="bg-black/50 backdrop-blur p-2 rounded-full text-white hover:bg-white/20 ml-2" title="å¼€å…³éº¦å…‹é£">
                        <!-- Mic On Icon -->
                        <svg id="icon-mic-on" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                        <!-- Mic Off Icon (Hidden) -->
                        <svg id="icon-mic-off" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="space-y-4 border-t border-white/10 pt-6">
                <h3 class="text-lg font-medium">è¿æ¥æ­¥éª¤</h3>
                
                <div id="sender-step-1">
                    <p class="text-sm text-gray-400 mb-2">1. å¤åˆ¶ <span class="text-purple-300">ä»£ç  A</span> å‘é€ç»™ç”µè„‘ï¼š</p>
                    <div class="relative">
                        <textarea id="sender-offer" readonly class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-purple-500 text-sm resize-none" placeholder="æ­£åœ¨åˆå§‹åŒ–æ‘„åƒå¤´..." onclick="this.select()"></textarea>
                        <button onclick="app.copyToClipboard('sender-offer')" class="absolute top-2 right-2 bg-white/20 hover:bg-white/30 text-xs px-3 py-1.5 rounded font-bold backdrop-blur-sm">å¤åˆ¶</button>
                    </div>
                </div>

                <div id="sender-step-2" class="opacity-50 pointer-events-none transition-opacity">
                    <p class="text-sm text-gray-400 mb-2">3. ç²˜è´´ç”µè„‘çš„ <span class="text-green-300">ä»£ç  B</span>ï¼š</p>
                    <textarea id="sender-answer-input" class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-purple-500 text-sm resize-none" placeholder="ç²˜è´´ä»£ç  B..."></textarea>
                    <button onclick="app.finalizeSenderConnection()" class="mt-3 btn-primary w-full py-3 rounded-lg font-medium shadow-lg shadow-purple-500/30">è¿æ¥ç”µè„‘</button>
                </div>
            </div>
        </div>

        <!-- Receiver Interface (PC) -->
        <div id="receiver-ui" class="hidden space-y-6">
            
            <!-- Connection Steps -->
            <div id="receiver-setup" class="space-y-4">
                <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-lg mb-4">
                    <h4 class="text-blue-400 text-sm font-bold mb-1">ğŸ’¡ å¦‚ä½•åœ¨ Zoom/ä¼šè®®ä¸­ä½¿ç”¨ï¼Ÿ</h4>
                    <p class="text-gray-300 text-xs">
                        1. å®‰è£… <strong>OBS Studio</strong>ã€‚<br>
                        2. æ·»åŠ â€œçª—å£é‡‡é›†â€é€‰æ‹©æ­¤æµè§ˆå™¨çª—å£ã€‚<br>
                        3. ç‚¹å‡» OBS çš„â€œå¯åŠ¨è™šæ‹Ÿæ‘„åƒæœºâ€ã€‚<br>
                        4. åœ¨ä¼šè®®è½¯ä»¶ä¸­é€‰æ‹©â€œOBS Virtual Cameraâ€ã€‚
                    </p>
                </div>

                <div id="receiver-step-1">
                    <p class="text-sm text-gray-400 mb-2">2. ç²˜è´´æ‰‹æœºçš„ <span class="text-purple-300">ä»£ç  A</span>ï¼š</p>
                    <textarea id="receiver-offer-input" class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-purple-500 text-sm resize-none" placeholder="ç²˜è´´ä»£ç  A..."></textarea>
                    <button onclick="app.createReceiverAnswer()" class="mt-2 btn-primary w-full py-2 rounded-lg font-medium text-sm shadow-lg shadow-purple-500/20">ç”Ÿæˆä»£ç  B</button>
                </div>

                <div id="receiver-step-2" class="hidden">
                    <p class="text-sm text-gray-400 mb-2">3. å¤åˆ¶ <span class="text-green-300">ä»£ç  B</span> å‘ç»™æ‰‹æœºï¼š</p>
                    <div class="relative">
                        <textarea id="receiver-answer" readonly class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-purple-500 text-sm resize-none" onclick="this.select()"></textarea>
                        <button onclick="app.copyToClipboard('receiver-answer')" class="absolute top-2 right-2 bg-white/20 hover:bg-white/30 text-xs px-3 py-1.5 rounded font-bold backdrop-blur-sm">å¤åˆ¶</button>
                    </div>
                    <div class="mt-4 text-center text-emerald-400 animate-pulse text-sm">
                        ç­‰å¾…æ‰‹æœºè¿æ¥...
                    </div>
                </div>
            </div>

            <!-- Video Display Area (Hidden initially) -->
            <div id="receiver-video-container" class="hidden text-center">
                <div class="relative group">
                    <!-- Added controls attribute to allow volume control on PC -->
                    <video id="remote-video" autoplay playsinline controls class="w-full rounded-lg shadow-2xl border border-white/10 bg-black"></video>
                    
                    <!-- Controls Overlay -->
                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="document.getElementById('remote-video').requestFullscreen()" class="bg-black/60 backdrop-blur px-4 py-2 rounded-full text-sm hover:bg-black/80">
                            å…¨å±æ˜¾ç¤º
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">æç¤ºï¼šç”µè„‘ç«¯å·²å¯ç”¨é»˜è®¤æ’­æ”¾å£°éŸ³ã€‚å¦‚æœäº§ç”Ÿå›éŸ³ï¼Œè¯·è°ƒèŠ‚æ’­æ”¾å™¨éŸ³é‡æˆ–ä½©æˆ´è€³æœºã€‚</p>
            </div>

        </div>

        <!-- Footer -->
        <div class="mt-8 pt-4 border-t border-white/5 text-center">
             <button onclick="location.reload()" class="text-xs text-gray-500 hover:text-gray-300 transition">é‡ç½® / æ–­å¼€è¿æ¥</button>
        </div>

    </main>

    <script>
        class CameraApp {
            constructor() {
                this.peerConnection = null;
                this.localStream = null;
                this.currentFacingMode = 'environment'; // default to back camera
                
                this.rtcConfig = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                };
            }

            show(id) { document.getElementById(id).classList.remove('hidden'); }
            hide(id) { document.getElementById(id).classList.add('hidden'); }

            async copyToClipboard(elementId) {
                const el = document.getElementById(elementId);
                el.select();
                try {
                    await navigator.clipboard.writeText(el.value);
                    const btn = el.parentElement.querySelector('button');
                    const originalText = btn.innerText;
                    btn.innerText = "å·²å¤åˆ¶!";
                    setTimeout(() => btn.innerText = originalText, 2000);
                } catch (err) {
                    alert("å¤åˆ¶å¤±è´¥");
                }
            }

            async requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        document.addEventListener('visibilitychange', async () => {
                            if (this.wakeLock !== null && document.visibilityState === 'visible') {
                                this.wakeLock = await navigator.wakeLock.request('screen');
                            }
                        });
                    }
                } catch (err) { console.log('Wake Lock error', err); }
            }

            // --- Sender Logic ---
            async initSender() {
                this.hide('step-selection');
                this.show('sender-ui');

                await this.startCamera();
                this.requestWakeLock();
                this.createPeerConnection();
            }

            async startCamera() {
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                }

                try {
                    // Now requesting both Video and Audio
                    this.localStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: this.currentFacingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 } 
                        }, 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });
                    
                    const videoEl = document.getElementById('local-video');
                    videoEl.srcObject = this.localStream;
                    
                    // Mirror effect only for user facing camera
                    videoEl.style.transform = this.currentFacingMode === 'user' ? 'scaleX(-1)' : 'none';

                    // If connection exists, replace track
                    if (this.peerConnection) {
                        const videoTrack = this.localStream.getVideoTracks()[0];
                        const sender = this.peerConnection.getSenders().find(s => s.track.kind === 'video');
                        if (sender) sender.replaceTrack(videoTrack);
                    }

                } catch (err) {
                    alert("æ— æ³•è®¿é—®æ‘„åƒå¤´: " + err.message);
                }
            }

            async switchCamera() {
                this.currentFacingMode = this.currentFacingMode === 'user' ? 'environment' : 'user';
                await this.startCamera();
            }

            toggleMic() {
                if (this.localStream) {
                    const audioTrack = this.localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        
                        // UI Update
                        const isEnabled = audioTrack.enabled;
                        document.getElementById('icon-mic-on').classList.toggle('hidden', !isEnabled);
                        document.getElementById('icon-mic-off').classList.toggle('hidden', isEnabled);
                        document.getElementById('btn-toggle-mic').classList.toggle('bg-red-500/20', !isEnabled);
                    }
                }
            }

            async createPeerConnection() {
                this.peerConnection = new RTCPeerConnection(this.rtcConfig);
                
                this.localStream.getTracks().forEach(track => {
                    this.peerConnection.addTrack(track, this.localStream);
                });

                // Create Data Channel for signaling stability
                this.peerConnection.createDataChannel("control");

                const offer = await this.peerConnection.createOffer();
                await this.peerConnection.setLocalDescription(offer);

                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate === null) {
                        const code = btoa(JSON.stringify(this.peerConnection.localDescription));
                        document.getElementById('sender-offer').value = code;
                        document.getElementById('sender-step-2').classList.remove('opacity-50', 'pointer-events-none');
                    }
                };
            }

            async finalizeSenderConnection() {
                const answerStr = document.getElementById('sender-answer-input').value.trim();
                if (!answerStr) return alert("è¯·ç²˜è´´ä»£ç  B");
                
                try {
                    const answerDesc = JSON.parse(atob(answerStr));
                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(answerDesc));
                    alert("è¿æ¥æˆåŠŸï¼");
                } catch (e) { alert("ä»£ç æ— æ•ˆ"); }
            }

            // --- Receiver Logic ---
            initReceiver() {
                this.hide('step-selection');
                this.show('receiver-ui');
                
                this.peerConnection = new RTCPeerConnection(this.rtcConfig);

                this.peerConnection.ontrack = (event) => {
                    const remoteStream = event.streams[0];
                    const videoEl = document.getElementById('remote-video');
                    videoEl.srcObject = remoteStream;
                    
                    this.hide('receiver-setup');
                    this.show('receiver-video-container');
                };
            }

            async createReceiverAnswer() {
                const offerStr = document.getElementById('receiver-offer-input').value.trim();
                if (!offerStr) return alert("è¯·ç²˜è´´ä»£ç  A");

                try {
                    const offerDesc = JSON.parse(atob(offerStr));
                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offerDesc));

                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);

                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate === null) {
                            const code = btoa(JSON.stringify(this.peerConnection.localDescription));
                            document.getElementById('receiver-answer').value = code;
                            this.hide('receiver-step-1');
                            this.show('receiver-step-2');
                        }
                    };
                } catch (e) { alert("ä»£ç æ— æ•ˆ"); }
            }
        }

        const app = new CameraApp();
    </script>
</body>
</html>
